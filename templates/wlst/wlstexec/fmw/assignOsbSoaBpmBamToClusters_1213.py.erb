
WLHOME      ='<%= @weblogic_home_dir %>'
DOMAIN_PATH ='<%= @domain_dir %>'

bpmEnabled     = <%= @bpm_enabled %>
bamEnabled     = <%= @bam_enabled %>
soaEnabled     = <%= @soa_enabled %>
osbEnabled     = <%= @osb_enabled %>
b2bEnabled     = <%= @b2b_enabled %>
essEnabled     = <%= @ess_enabled %>

SOAClusterName = '<%= @soa_cluster_name %>'
BAMClusterName = '<%= @bam_cluster_name %>'
OSBClusterName = '<%= @osb_cluster_name %>'
Admin          = '<%= @adminserver_name %>'

if   bamEnabled == true and soaEnabled == true and osbEnabled == true:
    AllClusters = '<%= @soa_cluster_name %>,<%= @osb_cluster_name %>,<%= @bam_cluster_name %>'
elif bamEnabled == true and soaEnabled == true and osbEnabled == false:
    AllClusters = '<%= @soa_cluster_name %>,<%= @bam_cluster_name %>'
elif bamEnabled == false and soaEnabled == true and osbEnabled == true:
    AllClusters = '<%= @soa_cluster_name %>,<%= @osb_cluster_name %>'
elif bamEnabled == false and soaEnabled == true and osbEnabled == false:
    AllClusters = '<%= @soa_cluster_name %>'
elif bamEnabled == false and soaEnabled == false and osbEnabled == true:
    AllClusters = '<%= @osb_cluster_name %>'

def getFirstClusterServer(cluster):
    s = ls('/Server')
    clustername = " "
    for token in s.split("drw-"):
        token=token.strip().lstrip().rstrip()
        path="/Server/"+token
        cd(path)
        if not token == Admin and not token == '':
            clustername = get('Cluster')
            searchClusterStr = cluster+":"
            clusterNameStr = str(clustername)
            if not clusterNameStr.find(searchClusterStr) == -1:
                return token    

def getClusterServers(cluster):
    servers = []
    s = ls('/Server')
    clustername = " "
    for token in s.split("drw-"):
        token=token.strip().lstrip().rstrip()
        path="/Server/"+token
        cd(path)
        if not token == Admin and not token == '':
            clustername = get('Cluster')
            searchClusterStr = cluster+":"
            clusterNameStr = str(clustername)
            if not clusterNameStr.find(searchClusterStr) == -1:
                servers.append(token)

    return servers   

def createSAFAgents(cluster, currentServerCnt):
    print ' '
    print "Creating SAF Servers for the cluster :- ", cluster
    s = ls('/Server')
    print ' '
    clustername = " "
    serverCnt = currentServerCnt
    for token in s.split("drw-"):
        token=token.strip().lstrip().rstrip()
        path="/Server/"+token
        cd(path)
        if not token == 'AdminServer' and not token == '':
            clustername = get('Cluster')
            print "Cluster Associated with the Server [",token,"] :- ",clustername
            print ' '
            searchClusterStr = cluster+":"
            clusterNameStr = str(clustername)
            print "searchClusterStr = ",searchClusterStr
            print "clusterNameStr = ",clusterNameStr
            if not clusterNameStr.find(searchClusterStr) == -1:
                print token, " is associated with ", cluster    
                cd('/')

                fileStoreName = 'WseeFileStore_auto_'+str(serverCnt)
                safAgent      = 'ReliableWseeSAFAgent_auto_'+str(serverCnt)
                
                cd('/')
                create(safAgent, 'SAFAgent')
                cd('/SAFAgent/'+safAgent)
                set ('Target'     , token)
                set ('Store'      , fileStoreName)
                set ('ServiceType','Both')
    
                serverCnt = serverCnt + 1

readDomain(DOMAIN_PATH)

cd('/')

if soaEnabled == true:
    cd('/Servers/soa_server1')
    set('ListenAddress','')

if bamEnabled == true:
    cd('/Servers/bam_server1')
    set('ListenAddress','')

if osbEnabled == true:
    cd('/Servers/osb_server1')
    set('ListenAddress','')

updateDomain()

serverGroupNone = []

if bamEnabled == true:
    print "change bam"
    bamServerGroup = ["BAM12-MGD-SVRS"]

    cd('/')
    setServerGroups('bam_server1', serverGroupNone)

    bamServers = getClusterServers(BAMClusterName)
    cd('/')
    for i in range(len(bamServers)):
      print "change servergroups for " + bamServers[i]
      setServerGroups(bamServers[i] , bamServerGroup)                      

    print "delete old bam"
    delete('bam_server1', 'Server')

if soaEnabled == true:
    print "change soa"

    if essEnabled == true:
        soaServerGroup = ["SOA-MGD-SVRS","ESS-MGD-SVRS"]
    else:
        soaServerGroup = ["SOA-MGD-SVRS"]

    cd('/')
    setServerGroups('soa_server1', serverGroupNone)                      

    soaServers = getClusterServers(SOAClusterName)
    cd('/')
    for i in range(len(soaServers)):
      print "change servergroups for " + soaServers[i]
      setServerGroups(soaServers[i] , soaServerGroup)                      

    print "delete old soa"
    delete('soa_server1', 'Server')

if osbEnabled == true:
    print "change osb"
    osbServerGroup  = ["OSB-MGD-SVRS-COMBINED"]

    cd('/')
    setServerGroups('osb_server1', serverGroupNone)                      

    osbServers = getClusterServers(OSBClusterName)
    cd('/')
    for i in range(len(osbServers)):
      print "change servergroups for " + osbServers[i]
      setServerGroups(osbServers[i] , osbServerGroup)                      

    print "delete old osb"
    delete('osb_server1', 'Server')
    OSBServer1Name = getFirstClusterServer(OSBClusterName)
    cd('/')
    print "osb old Singleton"
    assign('AppDeployment', 'Service Bus Cluster Singleton Marker Application', 'Target', OSBServer1Name)
    assign('AppDeployment', 'Service Bus Domain Singleton Marker Application' , 'Target', OSBServer1Name)

print "updateDomain"
updateDomain()
dumpStack()

print "change Coherence"
if soaEnabled == true:
    cd('/')
    assign('Cluster',SOAClusterName,'CoherenceClusterSystemResource','defaultCoherenceCluster')
if osbEnabled == true:
    cd('/')
    assign('Cluster',OSBClusterName,'CoherenceClusterSystemResource','defaultCoherenceCluster')
if bamEnabled == true:
    cd('/')
    assign('Cluster',BAMClusterName,'CoherenceClusterSystemResource','defaultCoherenceCluster')

cd('/')
cd('/CoherenceClusterSystemResource/defaultCoherenceCluster')
set('Target',AllClusters)
cd('CoherenceResource/defaultCoherenceCluster/CoherenceClusterParams/NO_NAME_0')
set('UnicastListenPort',9991) 

if soaEnabled == true:
    print "fix SOA"

if osbEnabled == true:
    print "fix OSB jms"
    cd('/')
    delete('ReliableWseeSAFAgent'  ,'SAFAgent')
    delete('OSBAQJMSServer'        ,'JMSSystemResource')
    delete('UMSAQJMSSystemResource','JMSSystemResource')
    createSAFAgents(OSBClusterName, 1)

if bamEnabled == true:
    print "to do fix BAM foreign jndi"
    cd('/')
    cd('/ForeignJNDIProvider/BAMForeignJndiProvider')
    set('Target',SOAClusterName)
    cd('/ForeignJNDIProvider/BPMForeignJndiProvider')
    set('Target',BAMClusterName)
    
    print "re-create BAM JMS"
    cd('/')
    delete('BamCQServiceJmsSystemResource_bam_server1','JMSSystemResource')
    delete('BamServerJmsSystemResource'               ,'JMSSystemResource')

    delete('BamCQServiceJmsServer_bam_server1'   ,'JMSServer')
    delete('BamServerJmsServer_bam_server1'      ,'JMSServer')

    delete('BamCQServiceJmsFileStore_bam_server1','FileStore')
    delete('BamServerJmsFileStore_bam_server1'   ,'FileStore')



print "last updateDomain"
updateDomain()
dumpStack()

print 'Successfully Updated SOA Domain.'

closeDomain() 